<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Options Income Screener Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #666;
    }
    select, input, button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #45a049;
    }
    .results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #ddd;
    }
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .strategy-CC {
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    .strategy-CSP {
      background: #fff3e0;
      color: #e65100;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    .score-high { color: #2e7d32; font-weight: 600; }
    .score-med { color: #f57c00; }
    .score-low { color: #c62828; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 4px; }
    .sentiment-long {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .sentiment-short {
      background: #ffebee;
      color: #c62828;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .sentiment-none {
      background: #f5f5f5;
      color: #757575;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted #666;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
    }
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“ˆ Options Income Screener Dashboard</h1>

    <div class="controls">
      <div class="control-group">
        <label>Date</label>
        <select id="dateSelect">
          <option value="latest">Latest</option>
        </select>
      </div>

      <div class="control-group">
        <label>Strategy</label>
        <select id="strategySelect">
          <option value="">All</option>
          <option value="CC">Covered Calls</option>
          <option value="CSP">Cash-Secured Puts</option>
        </select>
      </div>

      <div class="control-group">
        <label>Min Score</label>
        <input type="number" id="minScore" value="0" min="0" max="1" step="0.1">
      </div>

      <div class="control-group">
        <label>Min IV Rank</label>
        <input type="number" id="minIVR" value="40" min="0" max="100" step="5">
      </div>

      <div class="control-group">
        <label>Sentiment Signal ðŸŽ¯</label>
        <select id="sentimentSelect">
          <option value="">All</option>
          <option value="long">ðŸŸ¢ LONG (Buy)</option>
          <option value="short">ðŸ”´ SHORT (Sell)</option>
          <option value="none">âšª NONE (Neutral)</option>
        </select>
      </div>

      <button onclick="loadPicks()">Load Picks</button>
      <button onclick="loadStats()">View Stats</button>
    </div>

    <div class="stats-grid" id="stats" style="display:none;"></div>

    <div class="results">
      <div id="loading" class="loading">Loading...</div>
      <div id="error" class="error" style="display:none;"></div>
      <div id="content"></div>
    </div>
  </div>

  <script>
    // Company name mapping from expanded_universe.csv (all 111 symbols)
    const COMPANY_NAMES = {
      'AAPL': 'Apple Inc.',
      'MSFT': 'Microsoft Corporation',
      'GOOGL': 'Alphabet Inc. Class A',
      'AMZN': 'Amazon.com Inc.',
      'META': 'Meta Platforms Inc.',
      'NVDA': 'NVIDIA Corporation',
      'TSLA': 'Tesla Inc.',
      'AMD': 'Advanced Micro Devices Inc.',
      'NFLX': 'Netflix Inc.',
      'INTC': 'Intel Corporation',
      'CRM': 'Salesforce Inc.',
      'ORCL': 'Oracle Corporation',
      'CSCO': 'Cisco Systems Inc.',
      'ADBE': 'Adobe Inc.',
      'AVGO': 'Broadcom Inc.',
      'JPM': 'JPMorgan Chase & Co.',
      'BAC': 'Bank of America Corp.',
      'WFC': 'Wells Fargo & Company',
      'GS': 'Goldman Sachs Group Inc.',
      'MS': 'Morgan Stanley',
      'C': 'Citigroup Inc.',
      'BLK': 'BlackRock Inc.',
      'SCHW': 'Charles Schwab Corporation',
      'AXP': 'American Express Company',
      'V': 'Visa Inc.',
      'JNJ': 'Johnson & Johnson',
      'UNH': 'UnitedHealth Group Inc.',
      'LLY': 'Eli Lilly and Company',
      'PFE': 'Pfizer Inc.',
      'ABBV': 'AbbVie Inc.',
      'TMO': 'Thermo Fisher Scientific Inc.',
      'MRK': 'Merck & Co. Inc.',
      'ABT': 'Abbott Laboratories',
      'DHR': 'Danaher Corporation',
      'BMY': 'Bristol-Myers Squibb Company',
      'WMT': 'Walmart Inc.',
      'PG': 'Procter & Gamble Company',
      'KO': 'Coca-Cola Company',
      'PEP': 'PepsiCo Inc.',
      'COST': 'Costco Wholesale Corporation',
      'HD': 'Home Depot Inc.',
      'MCD': 'McDonald\'s Corporation',
      'NKE': 'Nike Inc.',
      'SBUX': 'Starbucks Corporation',
      'TGT': 'Target Corporation',
      'XOM': 'Exxon Mobil Corporation',
      'CVX': 'Chevron Corporation',
      'COP': 'ConocoPhillips',
      'SLB': 'Schlumberger Limited',
      'EOG': 'EOG Resources Inc.',
      'BA': 'Boeing Company',
      'CAT': 'Caterpillar Inc.',
      'HON': 'Honeywell International Inc.',
      'UPS': 'United Parcel Service Inc.',
      'GE': 'General Electric Company',
      'GME': 'GameStop Corp.',
      'AMC': 'AMC Entertainment Holdings Inc.',
      'BB': 'BlackBerry Limited',
      'PLTR': 'Palantir Technologies Inc.',
      'COIN': 'Coinbase Global Inc.',
      'HOOD': 'Robinhood Markets Inc.',
      'SOFI': 'SoFi Technologies Inc.',
      'RIVN': 'Rivian Automotive Inc.',
      'LCID': 'Lucid Group Inc.',
      'NIO': 'NIO Inc.',
      'PLUG': 'Plug Power Inc.',
      'SPCE': 'Virgin Galactic Holdings Inc.',
      'DKNG': 'DraftKings Inc.',
      'SNAP': 'Snap Inc.',
      'UBER': 'Uber Technologies Inc.',
      'BEAM': 'Beam Therapeutics Inc.',
      'ARCT': 'Arcturus Therapeutics Holdings Inc.',
      'FLGT': 'Fulgent Genetics Inc.',
      'ARVN': 'Arvinas Inc.',
      'CRSP': 'CRISPR Therapeutics AG',
      'BTAI': 'BioXcel Therapeutics Inc.',
      'EDIT': 'Editas Medicine Inc.',
      'IBRX': 'ImmunityBio Inc.',
      'OGN': 'Organon & Co.',
      'TWST': 'Twist Bioscience Corporation',
      'FATE': 'Fate Therapeutics Inc.',
      'SAVA': 'Cassava Sciences Inc.',
      'AXSM': 'Axsome Therapeutics Inc.',
      'MRNA': 'Moderna Inc.',
      'BNTX': 'BioNTech SE',
      'MU': 'Micron Technology Inc.',
      'QCOM': 'QUALCOMM Inc.',
      'AMAT': 'Applied Materials Inc.',
      'LRCX': 'Lam Research Corporation',
      'KLAC': 'KLA Corporation',
      'T': 'AT&T Inc.',
      'VZ': 'Verizon Communications Inc.',
      'TMUS': 'T-Mobile US Inc.',
      'CMCSA': 'Comcast Corporation',
      'DIS': 'Walt Disney Company',
      'SPG': 'Simon Property Group Inc.',
      'PLD': 'Prologis Inc.',
      'AMT': 'American Tower Corporation',
      'LIN': 'Linde plc',
      'APD': 'Air Products and Chemicals Inc.',
      'FCX': 'Freeport-McMoRan Inc.',
      'F': 'Ford Motor Company',
      'GM': 'General Motors Company',
      'ROKU': 'Roku Inc.',
      'SQ': 'Block Inc.',
      'PYPL': 'PayPal Holdings Inc.'
    };

    // Get company name for symbol
    function getCompanyName(symbol) {
      return COMPANY_NAMES[symbol] || symbol;
    }

    // Load dates on startup
    async function loadDates() {
      try {
        const resp = await fetch('/api/stats/dates');
        const data = await resp.json();
        if (data.success) {
          const select = document.getElementById('dateSelect');
          select.innerHTML = '<option value="latest">Latest</option>';
          data.dates.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.date;
            opt.textContent = `${d.date} (${d.count} picks)`;
            select.appendChild(opt);
          });
        }
      } catch (e) {
        console.error('Failed to load dates:', e);
      }
    }

    // Load picks
    async function loadPicks() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const content = document.getElementById('content');
      const stats = document.getElementById('stats');

      loading.style.display = 'block';
      error.style.display = 'none';
      content.innerHTML = '';
      stats.style.display = 'none';

      try {
        const date = document.getElementById('dateSelect').value;
        const strategy = document.getElementById('strategySelect').value;
        const minScore = document.getElementById('minScore').value;
        const minIVR = document.getElementById('minIVR').value;
        const sentimentSignal = document.getElementById('sentimentSelect').value;  // NEW

        let url = date === 'latest' ? '/api/picks/latest' :
          `/api/picks?date=${date}&strategy=${strategy}&minScore=${minScore}&minIVR=${minIVR}&sentimentSignal=${sentimentSignal}`;

        const resp = await fetch(url);
        const data = await resp.json();

        loading.style.display = 'none';

        if (data.success) {
          displayPicks(data.picks);
        } else {
          throw new Error(data.error);
        }
      } catch (e) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = `Error: ${e.message}`;
      }
    }

    // Display picks table
    function displayPicks(picks) {
      const content = document.getElementById('content');

      if (picks.length === 0) {
        content.innerHTML = '<p>No picks found</p>';
        return;
      }

      let html = `
        <h2>Found ${picks.length} Picks</h2>
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Stock Price</th>
              <th>Div Yield</th>
              <th>Earnings</th>
              <th>Strategy</th>
              <th>Sentiment ðŸŽ¯</th>
              <th>P/C Ratio</th>
              <th>CMF</th>
              <th>Strike</th>
              <th>Expiry</th>
              <th>Premium</th>
              <th>ROI (30d)</th>
              <th>IV Rank</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody>
      `;

      picks.forEach(p => {
        const scoreClass = p.score >= 0.7 ? 'score-high' :
                          p.score >= 0.5 ? 'score-med' : 'score-low';

        // Format dividend yield - show for CC picks, gray out for CSP
        let divYieldDisplay = '-';
        if (p.dividend_yield > 0) {
          divYieldDisplay = `${(p.dividend_yield * 100).toFixed(2)}%`;
        }
        const divYieldStyle = p.strategy === 'CSP' ? 'color: #ccc;' : '';

        // Format earnings with color-coding
        let earningsDisplay = '-';
        let earningsStyle = '';
        let earningsClass = '';

        if (p.earnings_date && p.earnings_days_until !== undefined && p.earnings_days_until < 999) {
          const daysUntil = p.earnings_days_until;
          const earnDate = new Date(p.earnings_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});

          // Color-code by proximity
          if (daysUntil < 7) {
            earningsStyle = 'color: #d32f2f; font-weight: 600;'; // Red - severe
            earningsDisplay = `${earnDate} (${daysUntil}d) ðŸ”´`;
          } else if (daysUntil < 14) {
            earningsStyle = 'color: #f57c00; font-weight: 600;'; // Orange - strong
            earningsDisplay = `${earnDate} (${daysUntil}d) ðŸŸ `;
          } else if (daysUntil < 21) {
            earningsStyle = 'color: #fbc02d; font-weight: 600;'; // Yellow - moderate
            earningsDisplay = `${earnDate} (${daysUntil}d) ðŸŸ¡`;
          } else if (daysUntil < 30) {
            earningsStyle = 'color: #7cb342;'; // Light green - light penalty
            earningsDisplay = `${earnDate} (${daysUntil}d) ðŸŸ¢`;
          } else {
            earningsStyle = 'color: #4caf50;'; // Green - safe
            earningsDisplay = `${earnDate} (${daysUntil}d) âœ…`;
          }
        }

        // Format sentiment data (v2.8)
        let sentimentDisplay = '-';
        let sentimentClass = 'sentiment-none';
        if (p.contrarian_signal) {
          const signal = p.contrarian_signal.toUpperCase();
          if (signal === 'LONG') {
            sentimentDisplay = 'ðŸŸ¢ LONG';
            sentimentClass = 'sentiment-long';
          } else if (signal === 'SHORT') {
            sentimentDisplay = 'ðŸ”´ SHORT';
            sentimentClass = 'sentiment-short';
          } else {
            sentimentDisplay = 'âšª NONE';
            sentimentClass = 'sentiment-none';
          }
        }

        // Format P/C ratio with tooltip
        let pcDisplay = '-';
        let pcTooltip = '';
        if (p.put_call_ratio !== null && p.put_call_ratio !== undefined) {
          const pc = p.put_call_ratio;
          pcDisplay = pc.toFixed(2);
          if (pc >= 1.5) {
            pcTooltip = 'Crowd fearful - High pessimism';
          } else if (pc >= 1.2) {
            pcTooltip = 'Bearish tilt';
          } else if (pc <= 0.7) {
            pcTooltip = 'Crowd greedy - High optimism';
          } else if (pc <= 0.9) {
            pcTooltip = 'Bullish tilt';
          } else {
            pcTooltip = 'Balanced sentiment';
          }
        }

        // Format CMF with tooltip
        let cmfDisplay = '-';
        let cmfTooltip = '';
        let cmfStyle = '';
        if (p.cmf_20 !== null && p.cmf_20 !== undefined) {
          const cmf = p.cmf_20;
          cmfDisplay = cmf >= 0 ? `+${cmf.toFixed(3)}` : cmf.toFixed(3);
          if (cmf >= 0.15) {
            cmfTooltip = 'Strong accumulation - Smart money buying';
            cmfStyle = 'color: #2e7d32; font-weight: 600;';
          } else if (cmf >= 0.05) {
            cmfTooltip = 'Accumulation - Buying pressure';
            cmfStyle = 'color: #7cb342;';
          } else if (cmf <= -0.15) {
            cmfTooltip = 'Strong distribution - Smart money selling';
            cmfStyle = 'color: #c62828; font-weight: 600;';
          } else if (cmf <= -0.05) {
            cmfTooltip = 'Distribution - Selling pressure';
            cmfStyle = 'color: #f57c00;';
          } else {
            cmfTooltip = 'Neutral money flow';
            cmfStyle = 'color: #757575;';
          }
        }

        // Get company name for tooltip
        const companyName = getCompanyName(p.symbol);

        html += `
          <tr>
            <td><div class="tooltip"><strong>${p.symbol}</strong><span class="tooltiptext">${companyName}</span></div></td>
            <td>$${p.stock_price ? p.stock_price.toFixed(2) : 'N/A'}</td>
            <td style="${divYieldStyle}">${divYieldDisplay}</td>
            <td style="${earningsStyle}">${earningsDisplay}</td>
            <td><span class="strategy-${p.strategy}">${p.strategy}</span></td>
            <td><span class="${sentimentClass}">${sentimentDisplay}</span></td>
            <td>${pcTooltip ? `<div class="tooltip">${pcDisplay}<span class="tooltiptext">${pcTooltip}</span></div>` : pcDisplay}</td>
            <td style="${cmfStyle}">${cmfTooltip ? `<div class="tooltip">${cmfDisplay}<span class="tooltiptext">${cmfTooltip}</span></div>` : cmfDisplay}</td>
            <td>$${p.strike}</td>
            <td>${p.expiry}</td>
            <td>$${p.premium.toFixed(2)}</td>
            <td>${(p.roi_30d * 100).toFixed(2)}%</td>
            <td>${p.iv_rank.toFixed(0)}%</td>
            <td class="${scoreClass}">${p.score.toFixed(2)}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      content.innerHTML = html;
    }

    // Load statistics
    async function loadStats() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const content = document.getElementById('content');
      const stats = document.getElementById('stats');

      loading.style.display = 'block';
      error.style.display = 'none';

      try {
        const resp = await fetch('/api/stats');
        const data = await resp.json();

        loading.style.display = 'none';

        if (data.success) {
          displayStats(data.stats);
        } else {
          throw new Error(data.error);
        }
      } catch (e) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = `Error: ${e.message}`;
      }
    }

    // Display statistics
    function displayStats(statsData) {
      const stats = document.getElementById('stats');
      const content = document.getElementById('content');

      stats.style.display = 'grid';
      content.innerHTML = '';

      const o = statsData.overall;
      stats.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${o.total_picks}</div>
          <div class="stat-label">Total Picks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${o.unique_symbols}</div>
          <div class="stat-label">Unique Symbols</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${o.days_with_picks}</div>
          <div class="stat-label">Days Tracked</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${(o.avg_roi * 100).toFixed(2)}%</div>
          <div class="stat-label">Avg ROI</div>
        </div>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDates();
      loadPicks();
    });
  </script>
</body>
</html>
